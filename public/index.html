<!DOCTYPE html>
<html>
<title>Madrid For All</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU"
  crossorigin="anonymous">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins">
<script src="https://www.w3schools.com/lib/w3.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pouchdb@7.0.0/dist/pouchdb.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pouchdb@7.0.0/dist/pouchdb.find.min.js"></script>
<style>
  body,
  h1,
  h2,
  h3,
  h4,
  h5 {
    font-family: "Poppins", sans-serif
  }

  body {
    font-size: 16px;
  }

  .w3-half img {
    margin-bottom: -6px;
    margin-top: 16px;
    opacity: 0.8;
    cursor: pointer
  }

  .w3-half img:hover {
    opacity: 1
  }
</style>

<body>

  <div w3-include-html="./menu.html"></div>

  <!-- !PAGE CONTENT! -->
  <div class="w3-main" style="margin-left:40px;margin-right:40px">

    <!-- Header -->
    <!-- Servicios -->
    <div class="w3-container" style="margin-top:20px" id="showcase">
      <h1 class="w3-jumbo"><b>Madrid For All</b></h1>
      <hr style="width:100px;border:5px solid gray" class="w3-round">
      <p>Selecciona una categoría y un servicio
        para ver dónde está y cómo puedes acceder
      </p>
    </div>

    <div class="w3-row w3-row-padding">
      <div class="w3-col m4 l2 w3-green">
        <div class="w3-cell">
          <p id="CAT1" onclick="onCategoryClick(this.id)">Servicios básicos</p>
        </div>
      </div>
      <div class="w3-col m4 l2 w3-green">
        <div class="w3-cell">
          <p id="CAT1" onclick="onCategoryClick(this.id)">Salud</p>
        </div>
      </div>
      <div class="w3-col m4 l2">
        <div class="w3-cell">
          <p id="CAT1" onclick="onCategoryClick(this.id)">Educación</p>
        </div>
      </div>
      <div class="w3-col m4 l2">
        <div class="w3-cell">
          <p id="CAT1" onclick="onCategoryClick(this.id)">Ocio</p>
        </div>
      </div>
      <div class="w3-col m4 l2">
        <div class="w3-cell">
          <p id="CAT1" onclick="onCategoryClick(this.id)">Información legal y asistencia jurídica</p>
        </div>
      </div>
      <div class="w3-col m4 l2">
        <div class="w3-cell">
          <p id="CAT1" onclick="onCategoryClick(this.id)">Información y orientación laboral</p>
        </div>
      </div>
    </div>
    <div class="w3-row w3-row-padding">
      <div class="w3-col m4 l2">
        <div class="w3-cell">
          <p id="CAT1" onclick="onCategoryClick(this.id)">Mujer</p>
        </div>
      </div>
      <div class="w3-col m4 l2">
        <div class="w3-cell">
          <p id="CAT1" onclick="onCategoryClick(this.id)">Infancia y jóvenes</p>
        </div>
      </div>
      <div class="w3-col m4 l2">
        <div class="w3-cell">
          <p id="CAT1" onclick="onCategoryClick(this.id)">Familia</p>
        </div>
      </div>
      <div class="w3-col m4 l2">
        <div class="w3-cell">
          <p id="CAT1" onclick="onCategoryClick(this.id)">LGTBIQ+</p>
        </div>
      </div>
      <div class="w3-col m4 l2">
        <div class="w3-cell">
          <p id="CAT1" onclick="onCategoryClick(this.id)">Diversidad funcional</p>
        </div>
      </div>
    </div>

    <br>

    <div class="w3-container">
      <div id="servicesMap" style="width:100%;height:800px;"></div>

      <br>
      
      <table id="resultTable" class="w3-table w3-striped w3-bordered">
        <thead>
          <tr class="w3-green">
            <th onclick="w3.sortHTML('#resultTable','.item', 'td:nth-child(1')">Nombre</th>
            <th onclick="w3.sortHTML('#resultTable','.item', 'td:nth-child(2)')">Distrito</th>
          </tr>
        </thead>
        <tr onclick="onRowClick({{orgName}})" w3-repeat="records" class="w3-padding-8 w3-hover-orange item">
          <td>
            <p>{{orgName}}</p>
            <p class="w3-small">{{languages}}</p>
          </td>
          <td>
            <p>{{district}}</p>
            <p class="w3-small">{{postalCode}}</p>
          </td>
        </tr>
      </table>
    </div>

    <!-- Pagination 
    <div class="w3-center">
      <div class="w3-bar">
        <a href="#" class="w3-bar-item w3-button">&laquo;</a>
        <a href="#" class="w3-button">1</a>
        <a href="#" class="w3-button">2</a>
        <a href="#" class="w3-button">3</a>
        <a href="#" class="w3-button">4</a>
        <a href="#" class="w3-button">&raquo;</a>
      </div>
    </div>
    -->
  </div>
  <!-- End page content / w3-main -->


  <!-- Footer -->
  <div class="w3-container w3-light-grey w3-padding-32" style="margin-top:75px;padding-right:58px">
    <!-- TODO: fill in correct link in href -->
    <p>Si quieres que tus servicios aparezcan en Madrid For All, rellena <a href="http://www.mundoenmovimiento.org">este formulario</a></p>
    <p>Puedes contactar con nosotros a través del correo info@mundoenmovimiento.org o de nuestra web www.mundoenmovimiento.org</p>
    <p class="w3-right">Powered by <a href="https://www.mundoenmovimiento.org" title="mundoenmovimiento" target="_blank"
        class="w3-hover-opacity">Mundo en Movimiento</a></p>
  </div>

  <script>
    // global variables
    var dbName = 'madrid4all.db';
    var db = new PouchDB(dbName);
    var map;
    var listOfMarkers;
    var listOfSelectedCategories = [];
    var mainCity = 'Madrid, ES';
    // detroy DB in order to recreate it from scratch
    db.destroy().then(
      function () {
        // Once we destroy the database, we have to create a new one otherwise we'll get an error, "Error: database is destroyed".
        db = new PouchDB(dbName);
        // initialize page content by loading its associated 'data.js'
        w3.getHttpObject("./data/data.json", initPageContent);
      }
    )
    /// callback to load the page content
    function initPageContent(arrayOfMarkers) {
      // check if the db is empty. In that case, load the content of data.js file
      db.info().then(function (result) {
        if (result.doc_count === 0) {
          console.log('DB empty! Lets add data.json into it...');
          db.bulkDocs(arrayOfMarkers).then(function (result) {
            console.log("Markers added successfully to DB. ");
            createDBIndexes();
          }).catch(function (err) {
            console.log("Error while adding markers to DB: " + err);
          });
        } else {
          console.log('DB not empty. It contains already ' + result.doc_count + ' records. No extra content is loaded from data.js.')
        }
        // add the markers to the map
        arrayOfMarkers.forEach(markerData => {
          // console.log("Adding marker " + markerData.orgName + ", " + markerData.address + " to the map...");
          addMarkerToMap(markerData);
        });
        // show table with the markers
        updateResultTable(arrayOfMarkers);
      });
    }
    function createDBIndexes() {
      // create the necessary db indexes
      db.createIndex({
        index: {
          fields: ['categories', 'orgName']
        }
      }).then(function (result) {
        console.log("Successfully created index over the categories");
      }).catch(function (err) {
        console.log("Error creating index on the categories: " + err);
      });
    }
    // function to update the resultTable
    function updateResultTable(arrayOfMarkers) {
      w3.displayObject("resultTable", { "records": arrayOfMarkers });
      w3.sortHTML('#resultTable', '.item', 'td:nth-child(1')
    }
    // Function to Show Map of Services
    function loadMap() {
      var geocoder = new google.maps.Geocoder();
      // mapPosition centered in 'mainCity'
      geocoder.geocode({ 'address': mainCity }, function (results, status) {
        if (status == 'OK') {
          var mapPosition = results[0].geometry.location;
          var mapCanvas = document.getElementById("servicesMap");
          var mapOptions = {
            // create map centered in 'mainCity'
            center: mapPosition,
            zoom: 12 // bigger number = closer map
          };
          // create new map and center it in 'mainCity'
          map = new google.maps.Map(mapCanvas, mapOptions);
        } else {
          console.log('Geocode of mainCity was not successful for the following reason: ' + status);
        }
      });
    }
    // adds a marker to the map.
    function addMarkerToMap(markerData) {
      // initialize variables
      var address = markerData.fullAddress;
      var markerPosition = new google.maps.LatLng(markerData.geocode);
      var marker = new google.maps.Marker({
        map: map,
        position: markerPosition,
        title: markerData.orgName + ". Click for more details"
      });
      // create an infoWindow to be linked to the marker
      var infowindow = new google.maps.InfoWindow({
        content: "<strong>" + markerData.orgName + "</strong><br><em>" + address + "</em><br><a href=\"" + markerData.orgWeb + "\">" + markerData.orgWeb + "</a>" // HTML contents of the InfoWindow
      });
      // add a Click Listener to our marker
      google.maps.event.addListener(marker, 'click', function () {
        infowindow.open(map, marker); // Open our InfoWindow
      });
    }
    // callback for the search by text
    function onTextSearchInput(inputValue) {
      w3.filterHTML('#resultTable', '.item', inputValue);
    }
    // callback for the search by text
    function onCategoryClick(selectedCategory) {
      console.log("Selected category " + selectedCategory);
      listOfSelectedCategories.push(selectedCategory);
      console.log("listOfSelectedCategories : " + listOfSelectedCategories.toString())
      db.find({
        selector: { categories: { $elemMatch: { $in: listOfSelectedCategories } } },
        fields: ['_id', 'orgName', 'district', 'postalCode', 'languages'],
      }).then(function (result) {
        var arrayOfMarkers = result["docs"];
        console.log(arrayOfMarkers.length + " markers found for category '" + selectedCategory + "'.");
        // show table with the markers
        updateResultTable(arrayOfMarkers);
      }).catch(function (err) {
        console.log(err);
      });
      //w3.filterHTML('#resultTable', '.item', selectedCategory);
    }
    // callback for the clock on a row of the result table
    function onRowClick(markerId) {
      console.log("Clicked row of marker with id: " + markerId);
      db.get(markerId + "").then(function (doc) {
        console.log("Fetched marker with id '" + doc["_id"] + "' and name '" + doc["orgName"] + "'-");
      }).catch(function (err) {
        console.log(err);
      });
    }
    // script to open and close sidebar
    function w3_open() {
      document.getElementById("mySidebar").style.display = "block";
      document.getElementById("myOverlay").style.display = "block";
    }
    function w3_close() {
      document.getElementById("mySidebar").style.display = "none";
      document.getElementById("myOverlay").style.display = "none";
    }
    // Modal Image Gallery
    function onClick(element) {
      document.getElementById("img01").src = element.src;
      document.getElementById("modal01").style.display = "block";
      var captionText = document.getElementById("caption");
      captionText.innerHTML = element.alt;
    }
  </script>

  <!-- Post DOM loaded actions -->
  <script>
    // include the HTML in separated files
    w3.includeHTML();
    // sort results table by column #1
    w3.sortHTML('#resultTable', '.item', 'td:nth-child(1)')
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-cYGCy5xyn4C5hH0rv7iWbw4nNGqcU0E&callback=loadMap"></script>

</body>

</html>